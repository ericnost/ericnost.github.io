<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miami, FL</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
		
	<link href='css/screen.css' rel='stylesheet' />
	
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
	
	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	
	<!--libs-->
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
	
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-label/v0.2.1/leaflet.label.css' rel='stylesheet' />
	
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	
	<script src="js/libs/leaflet.markercluster-src.js"></script>
	<link rel="stylesheet" href="js/libs/MarkerCluster.css" />
	<link rel="stylesheet" href="js/libs/MarkerCluster.Default.css" />
	
	<script src="js/libs/leaflet-search.src.js"></script>
	<link rel="stylesheet" href="js/libs/leaflet-search.src.css" />
	
	<script src="https://npmcdn.com/@turf/turf@3.5.1/turf.min.js"></script>
	<!--leaflet locate-->
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css' rel='stylesheet' />
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">	

  

</head>



<body>
<!--
    <nav class="navbar navbar-default ">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          
          <a class="navbar-brand" href="#">Miami, FL</a>
        </div>
       <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav"></ul>
        </div>/.nav-collapse 
      </div>
    </nav>
 -->
<style>
#directions,
#toggler {
    position: absolute;
    width: 33.3333%;
    max-width: 300px;
    min-width: 200px;
}

#directions {
    z-index: 99;
    background: rgba(0,0,0,.8);
    top: 66%;
    right: 0;
    bottom: 0;
    overflow: auto;
    display: none;
}
#toggler{
    bottom: 10px;
    right:0%;
    height:10px;
    display:none;
}

/*position the search bar and reset button*/
.controllers{
 position: absolute;
  right:1%;
  top: 10px;
}

/*hide certain mapbox features*/
.mapbox-directions-origin,
.mapbox-directions-icon,
.mapbox-reverse-icon,
.mapbox-directions-reverse-input,
.mapbox-directions-destination,
#mapbox-directions-destination-input,
.mapbox-directions-icon,
.mapbox-close-icon,
span.mapbox-directions-icon
{
  display: none;
}

</style>

<!-- call mapbox directions api -->
<script src="https://api.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.4.0/mapbox.directions.js"></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.4.0/mapbox.directions.css' type='text/css' />
 
<div id="map"></div>
<div class="controllers">
	<div id="searchBar"></div>
	<div id='inputs'></div>
	<div id="reset"></div>
</div>

<div id="buttons">
  <div id="city"><h2>city</h2></div>
  <div id="airport"><h2>airport</h2></div>
  <div id="seaport"><h2>seaport</h2></div>
</div>
<div id="toggler">Close Directions</div>
<div id='directions'>
  <div id='routes'></div>
  <div id='instructions'></div>
</div> 

<!-- <div id='errors'></div> -->


<div id="popupModal" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <div id="iconImg"></div>
        <h4 id=titleText class="modal-title" id="myModalLabel"></h4>
      </div>
      <div class="modal-body">
        
          <p id="address"></p>
          <p id="urlLink"></p>
          <p id="telLink"></p>
          <div id="directionsButton" class="btn btn-default" href="#" role="button"></div>
          <p id="mainText"></p>
          <div id="mainImg"></div>
      </div>
    </div>
  </div>
</div>
</body>


<script type='text/javascript'>

//edit setView options, reset for finals
L.mapbox.accessToken = 'pk.eyJ1IjoiYWlyZ3VpZGUiLCJhIjoiakgxYXYzayJ9.YXRafklbRVRelEXRLM0P0w';
var map = L.mapbox.map('map', 'airguide.l575n6j3',{
  attributionControl:true 
  })
  .setView([25.77313167630408, -80.19043207168579], 16);

//airguide attribution
map.attributionControl
  .addAttribution('<a>&copy; MMXV AirGuide / PMG Inc.</a>');

//global variables
var wcitiesLayer, seaportLayer, airportLayer, active, mark, markers, geolocated, check = false

var seaportData = "data/MIAseaport.csv";
var airportData = "data/MIA.csv";
var cityData = "data/MIAcity.csv";
  
var cityButton = document.getElementById('city');
var airportButton = document.getElementById('airport');
var seaportButton = document.getElementById('seaport');

//check for mobile
/*window.mobilecheck = function() {	
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
};*/

//what to do when a user geolocates
map.on('locationfound', onLocationFound);
function onLocationFound(e){
  point.geometry.coordinates[0] = e.longitude
  point.geometry.coordinates[1] = e.latitude
  map.removeLayer(mark)
  mark= L.marker([point.geometry.coordinates[1], point.geometry.coordinates[0]]).addTo(map); //markers have to be lat, long. but for turf spatial comparison, need long, lat.
  //automatically sets map extent...
  geolocated = true
}
///template for our markers
var point = {
  "type": "Feature",
  "properties": {
    "marker-color": "#0f0"
  },
  "geometry": {
    "type": "Point",
    "coordinates": [-80.19043207168579, 25.77313167630408]
  }
};
var defaultPoint = {"city": [25.77313167630408, -80.19043207168579], "airport": [25.79463636214593, -80.27778625488281], "seaport": [25.777923713875733, -80.16788005828857]}

mark= L.marker(defaultPoint.city).addTo(map); //default marker on load

//load different layers
cityButton.onclick = function (){
  reset() //clear any directions still open
  map.setView(defaultPoint.city, 16);
  map.removeLayer(mark)
  mark =  geolocated ? L.marker([point.geometry.coordinates[1], point.geometry.coordinates[0]]).addTo(map) : L.marker(defaultPoint.city).addTo(map); //use geolocation if allowed already, otherwise set a default marker
  point.geometry.coordinates = geolocated ? point.geometry.coordinates : defaultPoint.city.reverse()
  active =wcitiesLayer
};

airportButton.onclick = function (){
  reset()
  map.setView(defaultPoint.airport, 17);
  map.removeLayer(mark)
  mark =  geolocated ? L.marker([point.geometry.coordinates[1], point.geometry.coordinates[0]]).addTo(map) : L.marker(defaultPoint.airport).addTo(map);
  point.geometry.coordinates = geolocated ? point.geometry.coordinates : defaultPoint.airport.reverse()
  active=airportLayer
};

seaportButton.onclick = function (){
  reset()
  map.setView(defaultPoint.seaport, 16);
  map.removeLayer(mark)
  mark =  geolocated ? L.marker([point.geometry.coordinates[1], point.geometry.coordinates[0]]).addTo(map) : L.marker(defaultPoint.seaport).addTo(map);
  point.geometry.coordinates = geolocated ? point.geometry.coordinates : defaultPoint.seaport.reverse()
  active = seaportLayer
};

//clear map directions
$("#reset").html('<button onclick="reset()">Reset</button>')
function reset(){
  directions.setOrigin(undefined);
  directions.setDestination(undefined);
  $("#directions").hide()
  $("#toggler").hide()
}

//initialize search bar
$("#searchBar").html('<form><input name="inputbox" type="text" value="Find a place" id="stuffSearch"></form>') //<input type="button" value="Enter" onClick="find()">

  //add preventDefault handling to the input form
  $("#stuffSearch").keypress(function(e) {
      e = e || window.event
      var code = (e.keyCode ? e.keyCode : e.which);
      if(code == 13) { 
        e.preventDefault ? e.preventDefault() : e.returnValue = false; //prevent the page from treating button as a fetch from server
        find()
        return false
      }
  });

//close directions
$("#toggler").on("click", function(){
  $("#directions").toggle()
  $("#toggler").toggle()
})

function find (form, event) {
    var stuff = document.getElementById('stuffSearch').value

    var layers = active //make dynamic to either airport or seaport
    layers = layers._layers
    layers = jQuery.map(layers, function(n,i){
      return n.feature
    })
    layers = jQuery.grep(layers, function( n, i ) {
      return n.properties.title.toLowerCase().indexOf(stuff) != -1
    });
    if (layers.length > 0){ //if we found a result, map it
      layers = {
        "type": "FeatureCollection",
        "features": layers
      }
      var nearest = turf.nearest(point, layers);
      layers = null //clear memory

      //set directions
      directions.setOrigin(point)
      directions.setDestination(nearest)
      directions.query()
      
      //simulate click on icon to show modal
      var id = nearest.properties.title
      var layer = markers.getLayer(id);
      layer.fireEvent('click');  
       
      //set map view to right extent
      var point1 = jQuery.extend(true,[], point.geometry.coordinates) //deep copy of coordinates
      var point2 = jQuery.extend(true,[], nearest.geometry.coordinates)
      var x = L.latLngBounds(point1.reverse(), point2.reverse())
      map.fitBounds(x)
    } else{
      alert("Sorry, we couldn't find anything like that.") //or something fancier
    }
    
  } 

//settings for directions functionality
var directions = L.mapbox.directions();
directions.on("load", function(){
	//pull up directions
	$("#toggler").css("bottom", "35%")
	$("#toggler").show()
    $("#directions").show()
    //set map extent
      var point1 = jQuery.extend(true,[], this.origin.geometry.coordinates) //deep copy of coordinates
      var point2 = jQuery.extend(true,[], this.destination.geometry.coordinates)
      var x = L.latLngBounds(point1.reverse(), point2.reverse())
      map.fitBounds(x)
})
var directionsLayer = L.mapbox.directions.layer(directions)
    .addTo(map);

var directionsInputControl = L.mapbox.directions.inputControl('inputs', directions)
    .addTo(map);

//var directionsErrorsControl = L.mapbox.directions.errorsControl('errors', directions).addTo(map);

var directionsRoutesControl = L.mapbox.directions.routesControl('routes', directions)
    .addTo(map);

var directionsInstructionsControl = L.mapbox.directions.instructionsControl('instructions', directions)
    .addTo(map);

</script>
<script src="main_city.js"></script>
</html>