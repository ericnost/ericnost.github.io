
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>HousesForSale Zip Code Map</title>
    <meta charset="utf-8">

    <!-- Leaflet stylesheet -->
    <link rel="stylesheet" href="css/leaflet.css">
  </head>

  <body>
  <div id="map" style="width: 80%; height: 600px"></div>
    <!-- d3 library -->
    <script src="https://npmcdn.com/@turf/turf@3.5.1/turf.min.js"></script>
    <!-- Leaflet library -->
    <script src="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- TopoJson to convert geo data  -->
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <!-- Search libraries  -->
    <script src="js/libs/leaflet-search.src.js"></script>
    <link rel="stylesheet" href="js/libs/leaflet-search.src.css" />
    <script src='js/libs/leaflet-omnivore.min.js'></script>
    <link rel="stylesheet" href="css/zipcodemap.css" />

  
  <script>
  //global variables
  var allData, marker
  var check = false; //checks whether we've loaded layers before, in order to clear them

  loadData()
  //load topojson data for later use
  function loadData (){
    $.getJSON("data/USZipCodes.topo.json", function(zipTopo) {
      allData = topojson.feature(zipTopo, zipTopo.objects.zips)
    })
  }

  //set map
  var map = L.map('map').setView([39.333333, -97.583333], 4);
  map.on('click', function(e){finder(e, "click")})

    
  //basemap
  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    minZoom: 4,
    maxZoom: 12,
    attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> ' + ' Contributors | &copy;' + '<a href="http://www.mappingspecialists.com/">  Mapping Specialists, Ltd.</a>' 
  }).addTo(map);

  //scale bar
  L.control.scale({
      position: 'bottomright',
  })
  .addTo(map);

  // control that shows state info on hover
  var info = L.control({
      position: 'bottomleft',
  });
  info.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'info');
    this.update();
    return this._div;
  };
  info.update = function(codenum) {
    this._div.innerHTML = '<h4>Zip Code</h4>' + (codenum ?
      '<b>' + codenum.NAME  : 'Hover over zip code<br>or use search button above');
  };
  info.addTo(map);


  // search control
  var srch = L.control({
      position: 'topright',
  });
  srch.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'srch');
    L.DomEvent.disableClickPropagation(this._div)
     this._div.innerHTML = '<h4>Search: </h4><form><input type="text" size="15" id="zipSearch" placeholder="Enter a zip code" required></form>';
    return this._div;
  };
  srch.addTo(map);
  $("#zipSearch").on("keydown",function search(e) {     //jquery for search functionality
      if(e.keyCode == 13) { //if enter. instead, could do button
        zip = $( "#zipSearch" ).val()  
        removeLayers()//remove any layers 
        check=true; 
        finder(zip, "search")
        event.preventDefault();
      }
  });


  //remove layers
  function removeLayers(){
    if (check){
        map.removeLayer(mainLayer)
        map.removeLayer(nearLayer)
        map.removeLayer(marker)
    }
  }

  //find and display data
  function finder(data, type){
     removeLayers() //remove any already loaded layers
     check = true
     
     var geo = type == "click" ? [data.latlng.lng, data.latlng.lat] : data

      var thisData = type == "click" ?  allData.features.filter(function(d) {
          if (d.geometry && d.geometry.coordinates && d.geometry.coordinates[0]){ //for some reason, need to control for null geometry
            return turf.inside(geo, d)
          }
      })[0] : allData.features.filter(function(d) {return d.properties.NAME === geo; })[0];

      mainLayer = L.geoJson(thisData, {
        style: { 
          color: '#000',
          weight: 1.5,
          opacity: 1,
          fillColor: 'red'
        },
        onEachFeature: onEachFeature
        //if popup wanted, replace onEachFeature: onEachFeature with
        //      onEachFeature: function(feature, marker) {
        //      marker.bindPopup('<h4 style="color:'+feature.properties.color+'">'+ feature.properties.name +'</h4>');
        //    }
      }).addTo(map)

      //add a marker to the clicked location/county
      var mark = turf.centroid(thisData).geometry.coordinates.reverse() //can change so that on click, marker is where clicked
      marker = L.marker(mark).addTo(map)
      
      //set display area
      if (type == "click"){
        southWest = L.latLng(geo[1] - .1, geo[0] -.1);
        northEast = L.latLng(geo[1] + .1, geo[0] +.1);
        var bounds = L.latLngBounds(southWest, northEast);
        map.fitBounds(bounds)
      } else{ 
        map.fitBounds(mainLayer.getBounds()); var bounds = map.getBounds()
      };

      //make our search area a bit bigger
      bounds._northEast.lng = bounds._northEast.lng + .5
      bounds._northEast.lat = bounds._northEast.lat + .5
      bounds._southWest.lng = bounds._southWest.lng - .5
      bounds._southWest.lat = bounds._southWest.lat - .5
    
      var filterBounds = turf.bboxPolygon([bounds.getSouthWest().lng, bounds.getSouthWest().lat, bounds.getNorthEast().lng, bounds.getNorthEast().lat])

      //grab data within bounds
      var nearbyData = allData.features.filter(function(d) {
        if (d.geometry && d.geometry.coordinates && d.geometry.coordinates[0]){ //for some reason, need to control for null geometry
          var centroid = turf.centroid(d)
          return turf.inside(centroid, filterBounds)
        }
      })

      nearLayer = L.geoJson(nearbyData, {
        style: style,
        onEachFeature: onEachFeature
        //if popup wanted, replace onEachFeature: onEachFeature with
        //      onEachFeature: function(feature, marker) {
        //      marker.bindPopup('<h4 style="color:'+feature.properties.color+'">'+ feature.properties.name +'</h4>');
        //    }
      }).addTo(map)
  }

  function style(feature) {
    return {
      weight: 1.5,
      opacity: 1,
      color: '#fff',
      fillOpacity: 0.25,
      fillColor: '#FFEDA0'
    };
  }

  function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
      weight: 2,
      color: '#00F',
      fillOpacity: 0.5
    });

    if (!L.Browser.ie && !L.Browser.opera) {
      layer.bringToFront();
    }

    info.update(layer.feature.properties);
  }

  function resetHighlight(e) {
    nearLayer.resetStyle(e.target);
    info.update();
  }

  function activeStyle(e){
    e.target.setStyle({
        color: '#000',
        weight: 1.5,
        opacity: 1,
        fillColor: 'red'
    })

  }
  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight/*,
      click: function(e){
        //zoomToFeature(e);//resetHighlight(e); activeStyle(e)
      }*/
    });

  }


  </script>

  </body>
  </html>